{
  "id": "snapshot_1764838334631_2k15lo3nh",
  "approvalId": "approval_1764838116889_wineidjjf",
  "approvalTitle": "Technical Constitution - Angular v21 Coding Standards",
  "version": 2,
  "timestamp": "2025-12-04T08:52:14.631Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Angular v21 Technical Constitution\r\n\r\n> **This document is the supreme law for all code generation. Violations are bugs.**\r\n\r\n---\r\n\r\n## ğŸš¨ Priority 1: The Immutable Core\r\n\r\n*Source: Architecture Specification & Reactive Patterns Strategy*\r\n\r\nThese rules are **absolute**. No exceptions.\r\n\r\n### 1.1 Directory Structure (Strict Layering)\r\n\r\n```\r\nsrc/app/\r\nâ”œâ”€â”€ core/           # Singleton layer (loaded once)\r\nâ”‚   â”œâ”€â”€ auth/       # AuthService, Guards, Interceptors\r\nâ”‚   â”œâ”€â”€ layout/     # Header, Sidebar, Footer\r\nâ”‚   â”œâ”€â”€ config/     # InjectionTokens, AppConfig\r\nâ”‚   â””â”€â”€ store/      # Global state (if not feature-specific)\r\nâ”œâ”€â”€ shared/         # Reusable layer (zero business logic)\r\nâ”‚   â”œâ”€â”€ ui/         # Dumb/Presentational components\r\nâ”‚   â”œâ”€â”€ pipes/      # Data formatting\r\nâ”‚   â”œâ”€â”€ directives/ # Behavioral modifiers\r\nâ”‚   â””â”€â”€ utils/      # Pure helper functions\r\nâ””â”€â”€ features/       # Business layer (lazy-loaded)\r\n    â””â”€â”€ {feature}/\r\n        â”œâ”€â”€ *.routes.ts\r\n        â”œâ”€â”€ *.component.ts  # Smart/Container components\r\n        â””â”€â”€ ui/             # Feature-specific dumb components\r\n```\r\n\r\n**Rules:**\r\n- âŒ **FORBIDDEN**: Circular dependencies\r\n- âŒ **FORBIDDEN**: Feature A importing from Feature B\r\n- âŒ **FORBIDDEN**: Core importing from Features\r\n- âŒ **FORBIDDEN**: Shared components injecting Core services\r\n\r\n---\r\n\r\n### 1.2 State Management: RxJS + Signals Boundary\r\n\r\n**The Golden Rule**: RxJS stays inside Services; Signals go outside to Components.\r\n\r\n```\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚  SERVICE (Internal)                                     â”‚\r\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\r\nâ”‚  â”‚ BehaviorSubject â”‚â”€â”€â”€â–¶â”‚ RxJS Pipeline               â”‚ â”‚\r\nâ”‚  â”‚ Subject         â”‚    â”‚ (switchMap, debounce, etc.) â”‚ â”‚\r\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\r\nâ”‚                                        â”‚                â”‚\r\nâ”‚                              toSignal()â”‚                â”‚\r\nâ”‚                                        â–¼                â”‚\r\nâ”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚\r\nâ”‚                         â”‚ readonly signal = toSignal() â”‚â”‚\r\nâ”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n                                         â”‚\r\n                                         â–¼ PUBLIC API\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚  COMPONENT (External)                                   â”‚\r\nâ”‚  service.users()  â—€â”€â”€ Signal consumption only          â”‚\r\nâ”‚  {{ users() }}                                          â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n```\r\n\r\n#### âœ… DO: Declarative Data Fetching\r\n\r\n```typescript\r\n// Service\r\n@Injectable({ providedIn: 'root' })\r\nexport class UserService {\r\n  private http = inject(HttpClient);\r\n  private refresh$ = new BehaviorSubject<void>(void 0);\r\n\r\n  // Private RxJS stream\r\n  private usersStream$ = this.refresh$.pipe(\r\n    switchMap(() => this.http.get<User[]>('/api/users')),\r\n    shareReplay(1)\r\n  );\r\n\r\n  // Public Signal (the ONLY way to expose data)\r\n  readonly users = toSignal(this.usersStream$, { initialValue: [] });\r\n\r\n  refresh() {\r\n    this.refresh$.next();\r\n  }\r\n}\r\n```\r\n\r\n#### âŒ DO NOT: Manual Subscriptions in Components\r\n\r\n```typescript\r\n// FORBIDDEN - Never do this\r\n@Component({...})\r\nexport class BadComponent {\r\n  data: any;\r\n  \r\n  ngOnInit() {\r\n    // âŒ VIOLATION: Manual subscribe in component\r\n    this.service.getData().subscribe(d => this.data = d);\r\n  }\r\n}\r\n```\r\n\r\n#### âœ… DO: Signal Consumption in Components\r\n\r\n```typescript\r\n@Component({...})\r\nexport class GoodComponent {\r\n  private userService = inject(UserService);\r\n  \r\n  // Direct signal consumption - no subscribe needed\r\n  users = this.userService.users;\r\n  \r\n  // Derived state with computed\r\n  activeUsers = computed(() => \r\n    this.users().filter(u => u.isActive)\r\n  );\r\n}\r\n```\r\n\r\n---\r\n\r\n### 1.3 Smart vs Dumb Components\r\n\r\n| Aspect | Smart (Container) | Dumb (Presentational) |\r\n|--------|-------------------|----------------------|\r\n| **Location** | `features/{name}/` | `shared/ui/` |\r\n| **DI** | Injects Services/Stores | No DI (except utils) |\r\n| **State** | Manages data streams | Stateless |\r\n| **Communication** | Reads from Services | Input/Output only |\r\n| **Change Detection** | OnPush | OnPush |\r\n\r\n---\r\n\r\n## ğŸš¨ Priority 2: Modern Coding Standards\r\n\r\n*Source: Angular v21 Distilled Documentation*\r\n\r\nThese rules define **how** we write code. Legacy patterns are forbidden.\r\n\r\n### 2.1 Component Metadata\r\n\r\n```typescript\r\n// âœ… REQUIRED for ALL components\r\n@Component({\r\n  selector: 'app-user-card',\r\n  standalone: true,                              // MANDATORY\r\n  changeDetection: ChangeDetectionStrategy.OnPush, // MANDATORY\r\n  imports: [/* only what's needed */],\r\n  templateUrl: './user-card.component.html',\r\n})\r\nexport class UserCardComponent {}\r\n```\r\n\r\n### 2.2 Signal Inputs & New Outputs\r\n\r\n#### âŒ DO NOT: Decorator-based I/O\r\n\r\n```typescript\r\n// FORBIDDEN - Legacy decorators\r\n@Input() name: string = '';\r\n@Input({ required: true }) id!: number;\r\n@Output() delete = new EventEmitter<string>();\r\n```\r\n\r\n#### âœ… DO: Function-based I/O\r\n\r\n```typescript\r\n// REQUIRED - Signal Inputs & New Outputs\r\nname = input('');                    // Signal<string>\r\nid = input.required<number>();       // Signal<number>\r\ndelete = output<string>();           // OutputEmitterRef<string>\r\n\r\n// With transform\r\ndisabled = input(false, {\r\n  transform: (v: string | boolean) => v === '' || v === true\r\n});\r\n```\r\n\r\n### 2.3 Control Flow Syntax\r\n\r\n#### âŒ DO NOT: Structural Directives\r\n\r\n```html\r\n<!-- FORBIDDEN -->\r\n<div *ngIf=\"isLoggedIn; else loginTpl\">Welcome</div>\r\n<li *ngFor=\"let item of items; trackBy: trackById\">{{ item.name }}</li>\r\n<div [ngSwitch]=\"status\">...</div>\r\n```\r\n\r\n#### âœ… DO: Built-in Control Flow\r\n\r\n```html\r\n<!-- REQUIRED -->\r\n@if (user(); as u) {\r\n  <user-profile [data]=\"u\" />\r\n} @else if (loading()) {\r\n  <spinner />\r\n} @else {\r\n  <login-form />\r\n}\r\n\r\n<!-- @for MUST have track expression -->\r\n@for (item of items(); track item.id; let i = $index) {\r\n  <li>{{ i + 1 }}. {{ item.name }}</li>\r\n} @empty {\r\n  <li>No items found.</li>\r\n}\r\n\r\n@switch (status()) {\r\n  @case ('active') { <span class=\"badge-green\">Active</span> }\r\n  @case ('pending') { <span class=\"badge-yellow\">Pending</span> }\r\n  @default { <span class=\"badge-gray\">Unknown</span> }\r\n}\r\n```\r\n\r\n### 2.4 Signal Queries\r\n\r\n#### âŒ DO NOT: Decorator Queries\r\n\r\n```typescript\r\n// FORBIDDEN\r\n@ViewChild('chart') chartEl!: ElementRef;\r\n@ContentChildren(TabComponent) tabs!: QueryList<TabComponent>;\r\n```\r\n\r\n#### âœ… DO: Signal Queries\r\n\r\n```typescript\r\n// REQUIRED\r\nchartEl = viewChild<ElementRef>('chart');           // Signal<ElementRef | undefined>\r\nrequiredChart = viewChild.required<ElementRef>('chart'); // Signal<ElementRef>\r\nitems = viewChildren(ListItemComponent);            // Signal<ListItemComponent[]>\r\nheader = contentChild(HeaderComponent);             // Signal<HeaderComponent | undefined>\r\n```\r\n\r\n### 2.5 Dependency Injection\r\n\r\n```typescript\r\n// âœ… REQUIRED: Use inject() function\r\n@Component({...})\r\nexport class UserComponent {\r\n  private http = inject(HttpClient);\r\n  private userService = inject(UserService);\r\n  private route = inject(ActivatedRoute);\r\n}\r\n\r\n// âŒ FORBIDDEN: Constructor injection\r\nconstructor(private http: HttpClient) {} // DO NOT USE\r\n```\r\n\r\n### 2.6 Lifecycle & Cleanup\r\n\r\n```typescript\r\n// âœ… REQUIRED: Use DestroyRef for cleanup\r\nconstructor() {\r\n  inject(DestroyRef).onDestroy(() => {\r\n    // cleanup logic\r\n  });\r\n}\r\n\r\n// âœ… REQUIRED: Use afterNextRender for DOM access\r\nconstructor() {\r\n  afterNextRender(() => {\r\n    // Safe to access DOM here (SSR-compatible)\r\n    this.chart.init();\r\n  });\r\n}\r\n\r\n// âœ… REQUIRED: Use takeUntilDestroyed for subscriptions\r\nconstructor() {\r\n  interval(1000).pipe(\r\n    takeUntilDestroyed()\r\n  ).subscribe(console.log);\r\n}\r\n```\r\n\r\n---\r\n\r\n## âš ï¸ Priority 3: Quality & Consistency\r\n\r\n*Source: QA Testing Standards & Angular v21 Testing Guide*\r\n\r\n### 3.1 Testing Strategy: Two-Pillar Approach\r\n\r\n| Phase | Target | Tool | Action |\r\n|-------|--------|------|--------|\r\n| Logic Design | Services, Stores, Utils | **Vitest** | TDD - Write spec first |\r\n| UI Construction | Dumb Components | **Skip** | No unit tests |\r\n| Feature Integration | Smart Components | **Manual** | Developer verification |\r\n| Feature Completion | Critical Paths | **Playwright/Cypress** | E2E tests |\r\n\r\n### 3.2 Component Testing with Harnesses\r\n\r\n```typescript\r\n// âœ… REQUIRED: Use Component Harness, not querySelector\r\nit('should display user name', async () => {\r\n  const loader = TestbedHarnessEnvironment.loader(fixture);\r\n  const card = await loader.getHarness(UserCardHarness);\r\n  \r\n  expect(await card.getName()).toBe('John Doe');\r\n});\r\n\r\n// âŒ FORBIDDEN: Direct DOM queries in tests\r\nfixture.nativeElement.querySelector('.name').textContent; // DO NOT USE\r\n```\r\n\r\n### 3.3 Global Error Handler\r\n\r\n```typescript\r\n// REQUIRED: Implement in app.config.ts\r\n@Injectable()\r\nexport class GlobalErrorHandler implements ErrorHandler {\r\n  handleError(error: any) {\r\n    console.error('Unhandled error:', error);\r\n    // Send to logging service (Sentry, LogRocket, etc.)\r\n  }\r\n}\r\n\r\n// providers: [{ provide: ErrorHandler, useClass: GlobalErrorHandler }]\r\n```\r\n\r\n---\r\n\r\n## â„¹ï¸ Priority 4: UI & Styling\r\n\r\n*Reference guidance only*\r\n\r\n### 4.1 Technology Stack\r\n\r\n- **Layout & Spacing**: Tailwind CSS (utility-first)\r\n- **Complex Components**: PrimeNG (DataGrid, Datepicker, Dialogs)\r\n- **Customization**: Override via Tailwind utilities or CSS variables\r\n\r\n### 4.2 Image Optimization\r\n\r\n```html\r\n<!-- âœ… REQUIRED: Use NgOptimizedImage -->\r\n<img \r\n  ngSrc=\"user.jpg\" \r\n  width=\"400\" \r\n  height=\"400\"\r\n  priority  <!-- Add for LCP images -->\r\n/>\r\n\r\n<!-- âŒ FORBIDDEN -->\r\n<img src=\"user.jpg\" alt=\"User\">\r\n```\r\n\r\n### 4.3 Accessibility\r\n\r\n- Use semantic HTML (`<button>`, `<input>`) over `<div>`\r\n- Bind ARIA attributes to Signals: `[attr.aria-expanded]=\"isOpen()\"`\r\n- Ensure keyboard navigation for all interactive elements\r\n\r\n### 4.4 Performance Checklist\r\n\r\n- [ ] All components use `ChangeDetectionStrategy.OnPush`\r\n- [ ] All images use `ngSrc` with `width`/`height`\r\n- [ ] Heavy components wrapped in `@defer (on viewport)`\r\n- [ ] No expensive functions in template expressions (use `computed()`)\r\n\r\n---\r\n\r\n## Quick Reference: Forbidden vs Required\r\n\r\n| Category | âŒ Forbidden | âœ… Required |\r\n|----------|-------------|-------------|\r\n| **Inputs** | `@Input()` | `input()` / `input.required()` |\r\n| **Outputs** | `@Output()` + `EventEmitter` | `output()` |\r\n| **Queries** | `@ViewChild` / `@ContentChild` | `viewChild()` / `contentChild()` |\r\n| **Control Flow** | `*ngIf` / `*ngFor` / `*ngSwitch` | `@if` / `@for` / `@switch` |\r\n| **DI** | Constructor injection | `inject()` function |\r\n| **Subscriptions** | Manual `.subscribe()` in components | `toSignal()` / Signal consumption |\r\n| **Change Detection** | Default | `OnPush` |\r\n| **Components** | NgModule-based | `standalone: true` |\r\n| **Images** | `<img src=\"\">` | `<img ngSrc=\"\">` |\r\n",
  "fileStats": {
    "size": 12163,
    "lines": 382,
    "lastModified": "2025-12-04T08:48:29.431Z"
  },
  "comments": []
}